{% extends 'base.html' %}

{% block content %}
    <h1>Order #{{ order.pk }}</h1>
    <ul>
        {% for item in order.items.all %}
            <li>{{ item.name }} - ${{ item.price }}</li>
        {% endfor %}
    </ul>
    <button id="buy-button" onclick="fetch_session()">Buy</button>
{% endblock %}

{% block script %}
    <script src="https://js.stripe.com/v3/"></script>
    <script type="text/javascript">
        function fetch_session() {
            var stripe = Stripe('{{ stripe_public_key }}');
            fetch("{% url 'api:create_checkout_session' order.pk %}")
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error creating checkout session:', data.error);
                        alert('Failed to create checkout session.');
                        return;
                    }

                    console.info('Session ID =', data.session_id)

                    return stripe.redirectToCheckout({ sessionId: data.session_id });
                })
                .then((result) => {
                    if (result.error) {
                        alert(result.error.message);
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }
    </script>
{% endblock %}
